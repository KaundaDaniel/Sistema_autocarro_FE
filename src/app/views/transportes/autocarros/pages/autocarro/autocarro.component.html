<div class="container-scroller">
  <app-navbar></app-navbar>

  <div class="container-fluid page-body-wrapper">
    <app-sidebar></app-sidebar>

    <div class="main-panel">
      <div class="content-wrapper">
        <app-header></app-header>
        <div class="col-md-6">
          <h1 class="titulo-table">Autocarros</h1>
        </div>
        <div class="filtro-card p-3 mb-3 shadow-sm rounded bg-white">
          <div class="d-flex align-items-center flex-wrap gap-2">
            <!-- Select -->
            <div
              class="query-builder-container flex-grow-1"
              style="min-width: 200px; max-width: 250px"
            >
              <select
                class="form-select custom-select"
                [(ngModel)]="campoFiltro"
                name="campoFiltro"
              >
                <option disabled selected value="">Selecionar um campo</option>
                <option value="nomeEmpresa">Nome da Empresa</option>
                <option value="estado">Estado</option>
                <option value="matricula">Matricula</option>
                <option value="tipo">Tipo</option>
                <option value="capacidade">Capacidade</option>
                <option value="origem">Origem</option>
                <option value="destino">Destino</option>
              </select>
            </div>

            <!-- Input -->
            <div class="flex-grow-1" style="min-width: 250px; max-width: 300px">
              <input
                type="text"
                class="form-control"
                [(ngModel)]="valorFiltro"
                name="valorFiltro"
              />
            </div>

            <!-- Botões -->
            <div class="d-flex gap-2">
              <button
                class="btn btn-custom-verde"
                (keyup.enter)="filtrar()"
                (click)="filtrar()"
              >
                <i class="fas fa-search"></i> Filtrar
              </button>
              <button
                class="btn btn-outline-custom-vermelho"
                (click)="limparFiltro()"
              >
                <i class="fas fa-broom"></i> Limpar
              </button>
            </div>
          </div>
        </div>

        <!-- Cabeçalho + Botão -->
        <div class="row justify-content-between align-items-center mb-3">
          <div class="col-md-12 d-flex justify-content-end">
            <button class="btn btn-custom-red" (click)="abrirModal()">
              <i class="mdi mdi-plus"></i> Autocarro
            </button>
          </div>
        </div>

        <!-- Modal com ngx-bootstrap -->

        <ng-template #modalCriarAutocarro let-modal>
          <div class="modal-dialog modal-md">
            <!-- Adicionado modal-md para tamanho médio -->
            <div class="modal-content border-0">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title d-flex align-items-center">
                  <i class="fas fa-bus me-2"></i>
                  {{ isEditando ? "Editar" : "Novo" }} Autocarro
                </h5>
                <button
                  type="button"
                  class="close text-white"
                  (click)="modalRef?.hide()"
                  aria-label="Fechar"
                >
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>

              <form [formGroup]="autocarroForm" (ngSubmit)="salvarAutocarro()">
                <div class="modal-body">
                  <div class="row g-3">
                    <!-- Matricula -->
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Matricula</label>
                      <input
                        type="text"
                        class="form-control mb-2"
                        formControlName="matricula"
                        placeholder="Ex: AB-1234"
                        [ngClass]="{
                          'is-invalid': submitted && f.matricula.errors
                        }"
                      />
                      <div
                        *ngIf="submitted && f.matricula?.errors"
                        class="invalid-feedback"
                      >
                        Matrícula é obrigatória
                      </div>
                    </div>

                    <!-- Capacidade -->
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Capacidade</label>
                      <input
                        type="number"
                        class="form-control mb-2"
                        formControlName="capacidade"
                        placeholder="Ex: 50"
                        [ngClass]="{
                          'is-invalid': submitted && f.capacidade?.errors
                        }"
                      />
                      <div
                        *ngIf="submitted && f.capacidade?.errors"
                        class="invalid-feedback"
                      >
                        Capacidade inválida
                      </div>
                    </div>

                    <!-- Tipo -->
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Tipo</label>
                      <select
                        class="form-select mb-2"
                        formControlName="tipo"
                        [ngClass]="{
                          'is-invalid': submitted && f.tipo?.errors
                        }"
                      >
                        <option value="standard">Standard</option>
                        <option value="luxo">Luxo</option>
                      </select>
                      <div
                        *ngIf="submitted && f.tipo?.errors"
                        class="invalid-feedback"
                      >
                        Tipo é obrigatório
                      </div>
                    </div>

                    <!-- Estado -->
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Estado</label>
                      <select
                        class="form-select mb-2"
                        formControlName="estado"
                        [ngClass]="{
                          'is-invalid': submitted && f.estado?.errors
                        }"
                      >
                        <option value="disponivel">Disponível</option>
                        <option value="manutencao">Manutenção</option>
                      </select>
                      <div
                        *ngIf="submitted && f.estado?.errors"
                        class="invalid-feedback"
                      >
                        Estado é obrigatório
                      </div>
                    </div>

                    <!-- Empresa -->
                    <div class="col-12">
                      <label class="form-label fw-bold">Empresa</label>
                      <select
                        class="form-select mb-2"
                        formControlName="idEmpresa"
                        [ngClass]="{
                          'is-invalid': submitted && f.idEmpresa?.errors
                        }"
                      >
                        <option [value]="null" disabled selected>
                          -- Selecione uma empresa --
                        </option>
                        <option
                          *ngFor="let emp of empresas"
                          [value]="emp.idEmpresa"
                        >
                          {{ emp.nome }} ({{ emp.nif }})
                        </option>
                      </select>
                      <div
                        *ngIf="submitted && f.idEmpresa?.errors"
                        class="invalid-feedback"
                      >
                        Empresa é obrigatória
                      </div>
                    </div>
                  </div>
                </div>

                <div class="modal-footer border-top-0">
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    (click)="modalRef?.hide()"
                  >
                    <i class="fas fa-times me-1"></i> Cancelar
                  </button>
                  <button
                    type="submit"
                    class="btn btn-primary"
                    [disabled]="loading"
                  >
                    <i class="fas fa-save me-1"></i>
                    <span *ngIf="!loading">{{
                      isEditando ? "Atualizar" : "Salvar"
                    }}</span>
                    <span
                      *ngIf="loading"
                      class="spinner-border spinner-border-sm"
                      role="status"
                      aria-hidden="true"
                    ></span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </ng-template>

        <div class="container mt-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">
              <i class="fas fa-bus me-2 text-primary"></i>Autocarros disponíveis
            </h4>
            <span class="badge bg-primary"
              >{{ autocarros?.length || 0 }} registros</span
            >
          </div>
          <div class="autocarros-container">
            <div *ngIf="loading" class="d-flex justify-content-center my-3">
              <div class="spinner-grow text-danger" role="status">
                <span class="visually-hidden">A carregar...</span>
              </div>
            </div>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
              <div class="col mb-4" *ngFor="let autocarro of autocarros">
                <div
                  class="card mb-4 cursor-pointer h-100 border-0 shadow-sm hover-effect"
                  (click)="verDetalhes(autocarro.idAutocarro)"
                >
                  <div class="card-header bg-white border-bottom-0 pb-0">
                    <h5 class="card-title text-primary mb-1">
                      <i class="fas fa-bus text-muted me-2"></i>
                      {{ autocarro.matricula }}
                    </h5>
                    <span
                      class="badge"
                      [ngClass]="{
                        'bg-success': autocarro.estado === 'disponivel',
                        'bg-warning': autocarro.estado === 'manutencao'
                      }"
                    >
                      {{ autocarro.estado | titlecase }}
                    </span>
                  </div>

                  <div class="card-body pt-2">
                    <ul class="list-group list-group-flush">
                      <li
                        class="list-group-item d-flex justify-content-between border-0 px-0 py-2"
                      >
                        <span class="text-muted">Capacidade:</span>
                        <strong>{{ autocarro.capacidade }} lugares</strong>
                      </li>
                      <li
                        class="list-group-item d-flex justify-content-between border-0 px-0 py-2"
                      >
                        <span class="text-muted">Tipo:</span>
                        <strong>{{ autocarro.tipo | titlecase }}</strong>
                      </li>
                      <li
                        class="list-group-item d-flex justify-content-between border-0 px-0 py-2"
                      >
                        <span class="text-muted">Empresa:</span>
                        <strong>{{ autocarro.nomeEmpresa || "---" }}</strong>
                      </li>
                    </ul>
                  </div>

                  <div class="card-footer bg-white border-top-0 pt-0 pb-3">
                    <div class="d-flex justify-content-end gap-2">
                      <button
                        class="btn btn-sm btn-outline-primary d-flex align-items-center"
                        (click)="editar(autocarro.idAutocarro, $event)"
                      >
                        <i class="fas fa-edit me-1"></i> Editar
                      </button>
                      <button
                        class="btn btn-sm btn-outline-danger d-flex align-items-center"
                        (click)="apagar(autocarro.idAutocarro, $event)"
                      >
                        <i class="fas fa-trash-alt me-1"></i> Apagar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <nav
              *ngIf="totalRegistos > itensPorPagina"
              class="d-flex justify-content-center mt-4"
            >
              <ul class="pagination">
                <li
                  class="page-item"
                  [class.disabled]="paginaActual === 1"
                  (click)="paginaAlterada(paginaActual - 1)"
                >
                  <a class="page-link">Anterior</a>
                </li>

                <li
                  class="page-item"
                  *ngFor="let pagina of getPaginas()"
                  [class.active]="paginaActual === pagina"
                  (click)="paginaAlterada(pagina)"
                >
                  <a class="page-link">{{ pagina }}</a>
                </li>

                <li
                  class="page-item"
                  [class.disabled]="paginaActual === getPaginas().length"
                  (click)="paginaAlterada(paginaActual + 1)"
                >
                  <a class="page-link">Próxima</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
      <app-footer></app-footer>
    </div>
  </div>
</div>
